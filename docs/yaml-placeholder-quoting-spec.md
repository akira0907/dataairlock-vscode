# YAML プレースホルダーのクォート処理仕様（DataAirlock）

## 目的

DataAirlock は検出した PII をプレースホルダー（例: `[NAME_001]`）へ置換します。
YAML（`.yaml` / `.yml`）では、値や要素が `[` / `{` から始まると **flow collection（配列/マップ）** と解釈され得るため、プレースホルダーが YAML の構文エラーや型崩れを引き起こすことがあります。

本仕様は、YAML 出力が **常に YAML としてパース可能** であり、かつプレースホルダーが **文字列として扱われる** ことを保証するための後処理ルールを定義します。

## 想定する問題（現象）

### NG: プレースホルダーだけをクォートすると壊れる

```
担当者: 田中太郎（放射線診断）
```

`田中太郎` を `" [NAME_001] "` のように **プレースホルダーだけ** クォートして置換すると、

```
担当者: "[NAME_001]"（放射線診断）
```

となり、YAML 的に `"[NAME_001]"` という文字列の後ろに `（放射線診断）` が続くため **構文エラー** になります。

### OK: 値（要素）全体をクォートする

```
担当者: "[NAME_001]（放射線診断）"
```

## スコープ

対象: `.yaml` / `.yml` の匿名化出力（DataAirlock `Anonymizer.anonymize(..., isYamlFile=true)`）

対象外:
- ブロックスカラー（`|` / `>`）の内容行（インデントされた複数行テキスト）
  - ブロックスカラー内容は YAML のノードとしては文字列なので、プレースホルダーが先頭に来ても解釈が壊れません。

## 用語

- **プレースホルダー**: `\[(NAME|PHONE|EMAIL|ADDRESS|MYNUMBER|DOB)_\d{3}\]`
- **スカラー**: YAML の単一値（値全体、flow sequence の要素、flow mapping の key/value など）
- **スカラー先頭**: スカラー開始位置（区切り記号の直後）から空白を除いた最初の文字

## 要求仕様

### 1. 置換時はプレースホルダーのみを挿入する

- YAML であっても PII 置換は **プレースホルダーのみ** を挿入する
- プレースホルダー単体にクォートを付与しない（`"[NAME_001]"` を「差し込み」ない）

### 2. YAML 後処理（クォート付与）

匿名化後、YAML として次のルールで後処理する。

#### 2.1 行単位の前処理

- コメント行（先頭の非空白が `#`）は変更しない
- インラインコメントは分離して保持する
  - `#` がクォート外かつ直前が whitespace の場合にコメント開始とみなす
  - コメント部（`# ...`）はそのまま結合して復元する

#### 2.2 ブロックスカラーの扱い

- ブロックスカラー開始行（例: `key: |`, `key: >`, `- |`, `- >`）を検出したら、
  以降インデントが浅くなるまで **内容行を一切変更しない**

#### 2.3 クォート対象

クォート対象は **「クォートされていないスカラー」** のうち、
スカラー先頭がプレースホルダーから始まるもの。

- ブロック（通常）モード
  - `key: value` の key（key がプレースホルダーから始まる場合）
  - `key: value` の value
  - `- value` の value
- flow モード（`[...]` / `{...}`）
  - `[...]` の各要素
  - `{...}` の key / value（必要に応じて）

#### 2.4 クォート方法

- 対象スカラー全体を **ダブルクォート** で囲む
- スカラー内の `\` と `"` はエスケープする
  - `\` → `\\`
  - `"` → `\"`
- 末尾の空白はクォート外に残す（可能な範囲で）

### 3. 期待動作（例）

#### 3.1 通常の key-value（未クォート）

入力:
```
担当者: 田中太郎（放射線診断）
```

出力:
```
担当者: "[NAME_001]（放射線診断）"
```

#### 3.2 既にクォートされている値

入力:
```
担当者: "田中太郎（放射線診断）"
```

出力:
```
担当者: "[NAME_001]（放射線診断）"
```

（既に値全体がクォートされているので追加クォートは不要）

#### 3.3 flow sequence

入力:
```
names: [田中太郎, 鈴木花子]
```

出力:
```
names: ["[NAME_001]", "[NAME_002]"]
```

#### 3.4 値の途中に出現するプレースホルダー

入力:
```
note: 患者は田中太郎です
```

出力:
```
note: 患者は[NAME_001]です
```

（値の先頭ではないためクォート不要）

#### 3.5 インラインコメント

入力:
```
name: 田中太郎 # コメント
```

出力:
```
name: "[NAME_001]" # コメント
```

#### 3.6 ブロックスカラー

入力:
```
notes: |
  田中太郎（放射線診断）
```

出力:
```
notes: |
  [NAME_001]（放射線診断）
```

（内容行はクォートしない）

#### 3.7 キーがプレースホルダーから始まる場合

入力:
```
田中太郎: value
```

出力:
```
"[NAME_001]": value
```

## 実装メモ（受け入れ条件）

- 上記の例がすべて成立すること
- `"[NAME_001]"（…）` のような **プレースホルダー単体クォートの差し込み** が発生しないこと
- `npm test`（拡張機能テスト）で YAML 用テストが通ること
